<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Store Locations and Data Selection</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #header {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }
        #content {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            height: 90%;
        }
        #map {
            height: 90%;
            width: 50%;
            margin-top: 20px;
        }
        .chart-container {
            width: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin-top: 20px;
        }
        .chart {
            width: 100%;
            height: 45%;
        }
        #controls {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 10px;
}

        #controls {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 10px;
}
        #chart-options {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 10px;
            width: 100%;
        }
        #chart-options label {
            width: 45%;
            margin: 5px;
            display: flex;
            align-items: center;
        }
        .buttons-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
        }
        .buttons-container button {
            margin: 5px;
        }
        #year-select-container {
            margin-top: 10px;
            text-align: center;
        }

        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            display: none;
        }
        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        #data-table th {
            background-color: #f2f2f2;
        }
        highlight {
            fill: yellow !important;
            stroke: orange !important;
            stroke-width: 2 !important;
        }
        .legend {
            background: white;
            padding: 10px;
            margin-top: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            position: absolute;
            top: 760px; /* Adjust as needed */
            left: 1px; /* Adjust as needed */
        }
        .legend .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }
        .legend .legend-color.green {
            background: green;
        }
        .legend .legend-color.red {
            background: red;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Store Locations and Data Selection</h1>
    </div>
    <div id="content">
        <div id="map"></div>
        <div class="chart-container">
            <div id="controls">
                <label for="chart-select">Select Data:</label>
                <div id="chart-options">
                    <label><input type="checkbox" value="chart"> Sales Chart</label>
                    <label><input type="checkbox" value="customer-chart"> Customer Chart</label>
                    <label><input type="checkbox" value="order-chart"> Order Chart</label>
                    <label><input type="checkbox" value="avg-spending-chart"> Average Spending Chart</label>
                    <label><input type="checkbox" value="distance-chart"> Customer Distance Chart</label>
                    <label><input type="checkbox" value="cross-sell-chart"> Cross-Sell Chart</label>
                    <label><input type="checkbox" value="data-table"> Table</label>
                </div>
                <div class="buttons-container">
                    <button id="show-all">Show All</button>
                    <button id="update-chart">Update Data</button>
                    <button id="toggle-view">Show Selected Stores</button>
                    <button id="show-customers">Show Customers</button>
                </div>
                <div id="year-select-container">
                    <label for="year-select">Select Year:</label>
                    <select id="year-select">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>
                <canvas id="chart" class="chart"></canvas>
                <canvas id="customer-chart" class="chart"></canvas>
                <canvas id="order-chart" class="chart"></canvas>
                <canvas id="avg-spending-chart" class="chart"></canvas>
                <canvas id="distance-chart" class="chart"></canvas>
                <canvas id="cross-sell-chart" class="chart"></canvas>
                <table id="data-table">
                    <thead>


                    <tr>
                        <th>Store</th>
                        <th>Delta zum Vorjahr</th>
                        <th>Umsatz</th>
                        <th>Delta zum Vorjahr (%)</th>
                        <th>Kunden</th>
                        <th>Welta zum Vorjahr</th>
                        <th>Bestellungen-Jahr</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data will be populated dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color green"></div>
            <span>Green marker: Increase in revenue in the last year</span>
        </div>
        <div class="legend-item">
            <div class="legend-color red"></div>
            <span>Red marker: Decrease in revenue in the last year</span>
        </div>
        <div class="legend-item">
            <span>Marker size: Dependent on store revenue</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([37.7749, -122.4194], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var selectedStores = {};
        var chart, customerChart, orderChart, avgSpendingChart, distanceChart, crossSellChart;
        var availableYears = new Set();
        var markers = {};
        var customerMarkers = {};
        var showingAllStores = true;

        function getMarkerSize(total) {
            return Math.sqrt(total) * 0.05;
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function updateChart(selectedYear) {
            const labels = Array.from({ length: 12 }, (v, k) => new Date(0, k).toLocaleString('en', { month: 'short' }));
            const datasets = Object.values(selectedStores).map(store => {
                const monthlyTotals = Array(12).fill(0);
                if (store.monthlyTotals && store.monthlyTotals[selectedYear]) {
                    store.monthlyTotals[selectedYear].forEach((total, index) => {
                        monthlyTotals[index] = total;
                    });
                }
                return {
                    label: store.storeID,
                    data: monthlyTotals,
                    fill: false,
                    borderColor: store.color,
                    backgroundColor: store.color,
                    tension: 0.1
                };
            });

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(document.getElementById('chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Sales'
                            }
                        }
                    }
                }
            });
        }

        function updateCustomerChart(selectedYear) {
            const labels = Array.from({ length: 12 }, (v, k) => new Date(0, k).toLocaleString('en', { month: 'short' }));
            const datasetsPromises = Object.values(selectedStores).map(store => {
                return fetch(`/customers/${store.storeID}`)
                    .then(response => response.json())
                    .then(data => {
                        const monthlyCustomerCounts = Array(12).fill(0);
                        data.forEach(row => {
                            if (row.year == selectedYear) {
                                monthlyCustomerCounts[row.month - 1] = row.customer_count;
                            }
                        });
                        return {
                            label: store.storeID,
                            data: monthlyCustomerCounts,
                            fill: false,
                            borderColor: store.color,
                            backgroundColor: store.color,
                            tension: 0.1
                        };
                    });
            });

            Promise.all(datasetsPromises).then(datasets => {
                if (customerChart) {
                    customerChart.destroy();
                }

                customerChart = new Chart(document.getElementById('customer-chart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Customer Count'
                                }
                            }
                        }
                    }
                });
            });
        }

        function updateOrderChart(selectedYear) {
            const labels = Array.from({ length: 12 }, (v, k) => new Date(0, k).toLocaleString('en', { month: 'short' }));
            const datasetsPromises = Object.values(selectedStores).map(store => {
                return fetch(`/orders/monthly/${store.storeID}`)
                    .then(response => response.json())
                    .then(data => {
                        const monthlyOrderCounts = Array(12).fill(0);
                        data.forEach(row => {
                            if (row.year == selectedYear) {
                                monthlyOrderCounts[row.month - 1] = row.order_count;
                            }
                        });
                        return {
                            label: store.storeID,
                            data: monthlyOrderCounts,
                            fill: false,
                            borderColor: store.color,
                            backgroundColor: store.color,
                            tension: 0.1
                        };
                    });
            });

            Promise.all(datasetsPromises).then(datasets => {
                if (orderChart) {
                    orderChart.destroy();
                }

                orderChart = new Chart(document.getElementById('order-chart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Order Count'
                                }
                            }
                        }
                    }
                });
            });
        }

        function updateAvgSpendingChart(selectedYear) {
            const labels = Array.from({ length: 12 }, (v, k) => new Date(0, k).toLocaleString('en', { month: 'short' }));
            const datasetsPromises = Object.values(selectedStores).map(store => {
                return fetch(`/average_spending/${store.storeID}`)
                    .then(response => response.json())
                    .then(data => {
                        const monthlyAvgSpending = Array(12).fill(0);
                        data.forEach(row => {
                            if (row.year == selectedYear) {
                                monthlyAvgSpending[row.month - 1] = row.avg_spending;
                            }
                        });
                        return {
                            label: store.storeID,
                            data: monthlyAvgSpending,
                            fill: false,
                            borderColor: store.color,
                            backgroundColor: store.color,
                            tension: 0.1
                        };
                    });
            });

            Promise.all(datasetsPromises).then(datasets => {
                if (avgSpendingChart) {
                    avgSpendingChart.destroy();
                }

                avgSpendingChart = new Chart(document.getElementById('avg-spending-chart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Average Spending'
                                }
                            }
                        }
                    }
                });
            });
        }

        function updateDistanceChart(selectedYear) {
            const storeIDs = Object.keys(selectedStores);

            fetch('/customers_by_distance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    stores: storeIDs,
                    year: selectedYear
                })
            })
            .then(response => response.json())
            .then(data => {
                const labels = ['0-2 km', '2-5 km', '>5 km'];
                const datasets = storeIDs.map(storeID => {
                    const storeData = data[storeID] || {'0-2 km': 0, '2-5 km': 0, '>5 km': 0};
                    return {
                        label: `Store ${storeID}`,
                        data: [storeData['0-2 km'], storeData['2-5 km'], storeData['>5 km']],
                        backgroundColor: selectedStores[storeID].color
                    };
                });

                if (distanceChart) {
                    distanceChart.destroy();
                }

                distanceChart = new Chart(document.getElementById('distance-chart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Distance'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Customer Count'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching distance data:', error));
        }

        var crossSellChart;

        function updateCrossSellChart(selectedYear) {
            const storeIDs = Object.keys(selectedStores);

            const datasetsPromises = storeIDs.map(storeID => {
                return fetch(`/cross_sell_analysis/${storeID}?year=${selectedYear}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Data for Store ${storeID} and Year ${selectedYear}:`, data);

                        if (data.error) {
                            console.error(`Error fetching cross-sell data for Store ${storeID}:`, data.error);
                            return null;
                        }

                        if (data.length === 0) {
                            console.warn(`No data received for Store ${storeID} and Year ${selectedYear}`);
                            return null;
                        }

                        const labels = data.map(row => `${row.product1_name} & ${row.product2_name}`);
                        const counts = data.map(row => row.count);

                        return {
                            storeID: storeID,  // Save the store ID for later use
                            labels: labels,    // Save the labels for later use
                            dataset: {
                                label: `Store ${storeID}`,
                                data: counts,
                                backgroundColor: selectedStores[storeID].color,
                                borderColor: selectedStores[storeID].color,
                                borderWidth: 1
                            }
                        };
                    })
                    .catch(error => console.error(`Error fetching cross-sell data for Store ${storeID}:`, error));
            });

            Promise.all(datasetsPromises).then(results => {
                const datasets = results.filter(result => result !== null).map(result => result.dataset);

                if (datasets.length === 0) {
                    console.warn('No valid data received for cross-sell chart');
                    return;
                }

                if (crossSellChart) {
                    crossSellChart.destroy();
                }

                // Use the labels from the first dataset as they should be the same for all
                const labels = results[0].labels;

                crossSellChart = new Chart(document.getElementById('cross-sell-chart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Products'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Count'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error processing cross-sell data:', error));
        }

        function fetchDataForStore(storeID, year) {
            const previousYear = year - 1;

            return Promise.all([
                fetch(`/customerscount/${storeID}?year=${year}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error(`Error fetching customer data for Store ${storeID}:`, data.error);
                            return null;
                        }
                        console.log(`Customer data for Store ${storeID} and Year ${year}:`, data);
                        return { type: 'customers', year, data };
                    }),
                fetch(`/orderscount/${storeID}?year=${year}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error(`Error fetching order data for Store ${storeID}:`, data.error);
                            return null;
                        }
                        console.log(`Order data for Store ${storeID} and Year ${year}:`, data);
                        return { type: 'orders', year, data };
                    }),
                fetch(`/customerscount/${storeID}?year=${previousYear}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error(`Error fetching customer data for Store ${storeID} in previous year:`, data.error);
                            return null;
                        }
                        console.log(`Customer data for Store ${storeID} and Year ${previousYear}:`, data);
                        return { type: 'customers', year: previousYear, data };
                    }),
                fetch(`/orderscount/${storeID}?year=${previousYear}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error(`Error fetching order data for Store ${storeID} in previous year:`, data.error);
                            return null;
                        }
                        console.log(`Order data for Store ${storeID} and Year ${previousYear}:`, data);
                        return { type: 'orders', year: previousYear, data };
                    })
            ]).then(results => {
                results.forEach(result => {
                    if (result) {
                        if (result.type === 'customers') {
                            selectedStores[storeID].customerCounts = selectedStores[storeID].customerCounts || {};
                            result.data.forEach(row => {
                                selectedStores[storeID].customerCounts[row.year] = row.customer_count;
                            });
                        } else if (result.type === 'orders') {
                            selectedStores[storeID].orders = selectedStores[storeID].orders || {};
                            result.data.forEach(row => {
                                selectedStores[storeID].orders[row.year] = row.order_count;
                            });
                        }
                    }
                });

                updateTable(year); // Update the table for the current year
            }).catch(error => console.error('Error fetching data:', error));
        }

        function updateTable(selectedYear) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // Clear existing table data

            Object.values(selectedStores).forEach(store => {
                const previousYear = selectedYear - 1;

                // Calculate sales delta compared to the previous year
                const salesDelta = store.totals && store.totals[previousYear]
                    ? ((store.totals[selectedYear] - store.totals[previousYear]) / store.totals[previousYear] * 100).toFixed(2)
                    : 'N/A';
                const salesYear = store.totals && store.totals[selectedYear] ? store.totals[selectedYear] : 'N/A';

                // Calculate customer delta compared to the previous year
                const customerDelta = store.customerCounts && store.customerCounts[previousYear]
                    ? ((store.customerCounts[selectedYear] - store.customerCounts[previousYear]) / store.customerCounts[previousYear] * 100).toFixed(2)
                    : 'N/A';
                const customerYear = store.customerCounts && store.customerCounts[selectedYear] ? store.customerCounts[selectedYear] : 'N/A';

                // Calculate orders delta compared to the previous year
                const ordersDelta = store.orders && store.orders[previousYear]
                    ? ((store.orders[selectedYear] - store.orders[previousYear]) / store.orders[previousYear] * 100).toFixed(2)
                    : 'N/A';
                const ordersYear = store.orders && store.orders[selectedYear] ? store.orders[selectedYear] : 'N/A';

                // Log calculations for verification
                console.log(`Store: ${store.storeID}, Sales Previous Year: ${store.totals[previousYear]}, Sales Selected Year: ${store.totals[selectedYear]}, Sales Delta: ${salesDelta}`);
                console.log(`Store: ${store.storeID}, Customers Previous Year: ${store.customerCounts[previousYear]}, Customers Selected Year: ${store.customerCounts[selectedYear]}, Customer Delta: ${customerDelta}`);
                console.log(`Store: ${store.storeID}, Orders Previous Year: ${store.orders[previousYear]}, Orders Selected Year: ${store.orders[selectedYear]}, Orders Delta: ${ordersDelta}`);

                const row = document.createElement('tr');
                row.style.backgroundColor = store.color; // Set the background color of the row

                const storeCell = document.createElement('td');
                storeCell.textContent = store.storeID;
                row.appendChild(storeCell);

                const salesDeltaCell = document.createElement('td');
                salesDeltaCell.textContent = salesDelta !== 'N/A' ? salesDelta + '%' : 'N/A';
                row.appendChild(salesDeltaCell);

                const salesYearCell = document.createElement('td');
                salesYearCell.textContent = salesYear !== 'N/A' ? '$' + parseFloat(salesYear).toFixed(2) : 'N/A';
                row.appendChild(salesYearCell);

                const customerDeltaCell = document.createElement('td');
                customerDeltaCell.textContent = customerDelta !== 'N/A' ? customerDelta + '%' : 'N/A';
                row.appendChild(customerDeltaCell);

                const customerYearCell = document.createElement('td');
                customerYearCell.textContent = customerYear !== 'N/A' ? customerYear : 'N/A';
                row.appendChild(customerYearCell);

                const ordersDeltaCell = document.createElement('td');
                ordersDeltaCell.textContent = ordersDelta !== 'N/A' ? ordersDelta + '%' : 'N/A';
                row.appendChild(ordersDeltaCell);

                const ordersYearCell = document.createElement('td');
                ordersYearCell.textContent = ordersYear !== 'N/A' ? ordersYear : 'N/A';
                row.appendChild(ordersYearCell);

                tableBody.appendChild(row);
            });

            console.log('Table updated:', tableBody.innerHTML); // Log the updated table
        }

        // Example function call for each selected store and year
        Object.keys(selectedStores).forEach(storeID => {
            fetchDataForStore(storeID, 2022);
        });

        document.getElementById('update-chart').addEventListener('click', function() {
            const selectedYear = document.getElementById('year-select').value;
            Object.keys(selectedStores).forEach(storeID => {
                fetchDataForStore(storeID, selectedYear);
            });
        });

        document.getElementById('update-chart').addEventListener('click', function() {
            const selectedYear = document.getElementById('year-select').value;
            const selectedCharts = Array.from(document.querySelectorAll('#chart-options input:checked')).map(input => input.value);

            showChart(selectedCharts);

            selectedCharts.forEach(chart => {
                if (chart === 'chart') {
                    updateChart(selectedYear);
                } else if (chart === 'customer-chart') {
                    updateCustomerChart(selectedYear);
                } else if (chart === 'order-chart') {
                    updateOrderChart(selectedYear);
                } else if (chart === 'avg-spending-chart') {
                    updateAvgSpendingChart(selectedYear);
                } else if (chart === 'distance-chart') {
                    updateDistanceChart(selectedYear);
                } else if (chart === 'cross-sell-chart') {
                    updateCrossSellChart(selectedYear);
                } else if (chart === 'data-table') {
                    updateTable(selectedYear);
                }
            });
        });

        var showingAllCharts = false;

        document.getElementById('show-all').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('#chart-options input[type="checkbox"]');
            const selectedYear = document.getElementById('year-select').value;

            if (showingAllCharts) {
                checkboxes.forEach(checkbox => checkbox.checked = false);
                showChart([]);
                showingAllCharts = false;
                this.textContent = 'Show All';
            } else {
                checkboxes.forEach(checkbox => checkbox.checked = true);
                const selectedCharts = Array.from(checkboxes).map(input => input.value);
                showChart(selectedCharts);

                selectedCharts.forEach(chart => {
                    if (chart === 'chart') {
                        updateChart(selectedYear);
                    } else if (chart === 'customer-chart') {
                        updateCustomerChart(selectedYear);
                    } else if (chart === 'order-chart') {
                        updateOrderChart(selectedYear);
                    } else if (chart === 'avg-spending-chart') {
                        updateAvgSpendingChart(selectedYear);
                    } else if (chart === 'distance-chart') {
                        updateDistanceChart(selectedYear);
                    } else if (chart === 'cross-sell-chart') {
                        updateCrossSellChart(selectedYear);
                    } else if (chart === 'data-table') {
                        updateTable(selectedYear);
                    }
                });

                showingAllCharts = true;
                this.textContent = 'Hide All';
            }
        });

        function showChart(chartIds) {
            const charts = ['chart', 'customer-chart', 'order-chart', 'avg-spending-chart', 'distance-chart', 'cross-sell-chart', 'data-table'];
            charts.forEach(id => {
                if (chartIds.includes(id)) {
                    document.getElementById(id).style.display = 'block';
                } else {
                    document.getElementById(id).style.display = 'none';
                }
            });
        }

        document.getElementById('toggle-view').addEventListener('click', function() {
            if (showingAllStores) {
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                Object.keys(selectedStores).forEach(storeID => {
                    map.addLayer(markers[storeID]);
                });
                document.getElementById('toggle-view').textContent = 'Show All Stores';
            } else {
                Object.values(markers).forEach(marker => map.addLayer(marker));
                document.getElementById('toggle-view').textContent = 'Show Selected Stores';
            }
            showingAllStores = !showingAllStores;
        });

        document.getElementById('show-customers').addEventListener('click', function() {
            if (showingAllStores) {
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                fetch('/customers/locations')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(customer => {
                            let marker = L.circleMarker([customer.latitude, customer.longitude], {
                                radius: 5,
                                color: 'blue',
                                fillColor: 'blue',
                                fillOpacity: 0.5,
                                weight: 1
                            }).addTo(map);

                            marker.bindPopup(`<b>${customer.customerID}</b><br>${customer.city}, ${customer.state}`);
                            customerMarkers[customer.customerID] = marker;
                        });
                    })
                    .catch(error => console.error('Error fetching customer data:', error));
                showingAllStores = false;
                this.textContent = 'Show Stores';
            } else {
                Object.values(customerMarkers).forEach(marker => map.removeLayer(marker));
                Object.values(markers).forEach(marker => map.addLayer(marker));
                showingAllStores = true;
                this.textContent = 'Show Customers';
            }
        });

        function showCustomersNearStore(storeID) {
            fetch(`/customers/near_store/${storeID}`)
                .then(response => response.json())
                .then(data => {
                    // Remove existing customer markers
                    Object.values(customerMarkers).forEach(marker => map.removeLayer(marker));
                    customerMarkers = {};

                    // Add new markers for customers near the selected store
                    data.forEach(customer => {
                        let marker = L.circleMarker([customer.latitude, customer.longitude], {
                            radius: 10,  // Set the radius to 10
                            color: 'black',
                            fillColor: 'black',
                            fillOpacity: 0.5,
                            weight: 1
                        }).addTo(map);

                        marker.bindPopup(`<b>Customer ID: ${customer.customerID}</b><br>Order Rate: ${customer.order_rate}`);
                        customerMarkers[customer.customerID] = marker;
                    });

                    alert(`Store ${storeID} has ${data.length} customers within 10 miles.`);
                })
                .catch(error => console.error('Error fetching customers near store:', error));
        }

        function highlightMarker(storeID) {
            Object.values(markers).forEach(marker => {
                if (selectedStores[marker.options.storeID]) {
                    marker.setStyle({
                        fillColor: selectedStores[marker.options.storeID].color,
                        color: selectedStores[marker.options.storeID].color
                    });
                } else {
                    marker.setStyle({
                        fillColor: marker.options.originalColor,
                        color: marker.options.originalColor
                    });
                }
            });

            if (markers[storeID]) {
                markers[storeID].setStyle({
                    fillColor: selectedStores[storeID].color,
                    color: selectedStores[storeID].color,
                    weight: 2
                });
            }
        }

        fetch('/stores')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                let stores = {};
                data.forEach(store => {
                    if (!stores[store.storeID]) {
                        stores[store.storeID] = {
                            latitude: store.latitude,
                            longitude: store.longitude,
                            city: store.city,
                            state: store.state,
                            totals: {},
                            monthlyTotals: {},
                            customerCounts: {},
                            orders: {},
                            years: []
                        };
                    }
                    if (!stores[store.storeID].monthlyTotals[store.year]) {
                        stores[store.storeID].monthlyTotals[store.year] = Array(12).fill(0);
                    }
                    stores[store.storeID].totals[store.year] = (stores[store.storeID].totals[store.year] || 0) + store.total;
                    stores[store.storeID].monthlyTotals[store.year][store.month - 1] += store.total;
                    stores[store.storeID].customerCounts[store.year] = store.customerCount;
                    stores[store.storeID].orders[store.year] = store.ordersCount;
                    availableYears.add(store.year);
                    if (!stores[store.storeID].years.includes(store.year)) {
                        stores[store.storeID].years.push(store.year);
                    }
                });

                const yearSelect = document.getElementById('year-select');
                availableYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });

                const sortedStoreIDs = Object.keys(stores).sort((a, b) => {
                    const totalA = Object.values(stores[a].totals).reduce((x, y) => x + y, 0);
                    const totalB = Object.values(stores[b].totals).reduce((x, y) => x + y, 0);
                    return totalB - totalA;
                });

                sortedStoreIDs.forEach(storeID => {
                    let store = stores[storeID];
                    let totalSales = Object.values(store.totals).reduce((a, b) => a + b, 0);
                    let markerSize = getMarkerSize(totalSales);

                    let popupContent = `<b>${storeID}</b><br>${store.city}, ${store.state}<br>`;
                    let prevTotal = null;
                    let lastArrow = '';
                    let lastDiff = 0;

                    for (let year in store.totals) {
                        let total = store.totals[year];
                        let arrow = '';
                        let delta = '';

                        if (prevTotal !== null) {
                            let diff = total - prevTotal;
                            if (diff > 0) {
                                arrow = '▲';
                                delta = `(+${diff.toFixed(2)})`;
                                lastArrow = '▲';
                                lastDiff = diff;
                            } else if (diff < 0) {
                                arrow = '▼';
                                delta = `(${diff.toFixed(2)})`;
                                lastArrow = '▼';
                                lastDiff = diff;
                            }
                        }

                        prevTotal = total;

                        popupContent += `Year ${year}: $${total} <span class="${arrow === '▲' ? 'up-arrow' : 'down-arrow'}">${arrow}</span> ${delta}<br>`;
                    }

                    let markerColor = lastArrow === '▲' ? 'green' : 'red';
                    store.color = getRandomColor();

                    let marker = L.circleMarker([store.latitude, store.longitude], {
                        radius: markerSize,
                        color: 'blue',  // Set the border color to blue
                        fillColor: markerColor,
                        fillOpacity: 0.5,
                        weight: 3,  // Set the border thickness
                        originalColor: markerColor,
                        storeID: storeID
                    }).addTo(map);

                    marker.bindPopup(popupContent);

                    marker.on('click', function() {
                        if (selectedStores[storeID]) {
                            markers[storeID].setStyle({ fillColor: marker.options.originalColor });
                            delete selectedStores[storeID];
                        } else {
                            selectedStores[storeID] = {
                                storeID: storeID,
                                totals: store.totals,
                                monthlyTotals: store.monthlyTotals,
                                customerCounts: store.customerCounts,
                                orders: store.orders,
                                years: store.years,
                                color: store.color
                            };
                            markers[storeID].setStyle({ fillColor: store.color });
                            highlightMarker(storeID);
                            showCustomersNearStore(storeID); // Show customers near the selected store
                        }
                        const selectedYear = document.getElementById('year-select').value;
                        const selectedCharts = Array.from(document.querySelectorAll('#chart-options input:checked')).map(input => input.value);

                        showChart(selectedCharts);

                        selectedCharts.forEach(chart => {
                            if (chart === 'chart') {
                                updateChart(selectedYear);
                            } else if (chart === 'customer-chart') {
                                updateCustomerChart(selectedYear);
                            } else if (chart === 'order-chart') {
                                updateOrderChart(selectedYear);
                            } else if (chart === 'avg-spending-chart') {
                                updateAvgSpendingChart(selectedYear);
                            } else if (chart === 'distance-chart') {
                                updateDistanceChart(selectedYear);
                            } else if (chart === 'cross-sell-chart') {
                                updateCrossSellChart(selectedYear);
                            } else if (chart === 'data-table') {
                                updateTable(selectedYear);
                            }
                        });
                    });

                    markers[storeID] = marker;
                });
            })
            .catch(error => console.error('Error fetching store data:', error));
    </script>
</body>
</html>
