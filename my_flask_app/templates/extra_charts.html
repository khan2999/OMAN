<!DOCTYPE html>
<html>
<head>
    <title>Sales Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1;
            width: 80%;
            margin: 20px auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #plot-container {
            width: 100%;
            height: 500px;
            margin-top: 20px;
        }

        #api-dropdown, .filter {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .spinner {
            margin-top: 20px;
            display: none;
        }

        .spinner div {
            width: 18px;
            height: 18px;
            background-color: #333;
            border-radius: 100%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .spinner div:nth-child(1) {
            animation-delay: -0.32s;
        }

        .spinner div:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const apiDropdown = document.getElementById("api-dropdown");
            const plotContainer = document.getElementById("plot-container");
            const filterContainer = document.getElementById("filter-container");
            const spinner = document.querySelector('.spinner');
            let currentApi = null;

            apiDropdown.addEventListener("change", async () => {
                const selectedApi = apiDropdown.value;
                currentApi = selectedApi;

                Plotly.purge(plotContainer);
                filterContainer.innerHTML = '';
                spinner.style.display = 'block';

                const response = await fetch(`/api/${selectedApi}`);
                const data = await response.json();

                spinner.style.display = 'none';

                if (selectedApi === 'sales_by_day_of_week') {
                    createBarPlot(data, 'day_of_week', 'total_sales', 'Sales by Day of Week');
                } else if (selectedApi === 'product_size_sales') {
                    createPieChart(data, 'Size', 'total_quantity_sold', 'Product Size Sales');
                } else if (selectedApi === 'distance_analysis') {
                    createScatterPlot(data, 'distance_bin', ['order_frequency_mean', 'total_sales_mean'], 'Distance Analysis');
                } else if (selectedApi === 'store_performance_by_category') {
                    createStackedBarChart(data, 'storeID', 'Category', 'total_quantity_sold', 'Store Performance by Category');
                    createStoreCategoryFilters(data);
                } else if (selectedApi === 'customer_segmentation') {
                    createBubbleChart(data, 'total_spend', 'num_orders', 'city', 'state', 'Customer Segmentation');
                } else if (selectedApi === 'store_performance_comparison') {
                    createGroupedBarChart(data, 'storeID', ['total_sales', 'num_orders', 'average_order_size'], 'Store Performance Comparison');
                } else if (selectedApi === 'inventory_turnover_rate') {
                    createBarPlot(data, 'SKU', 'turnover_rate', 'Inventory Turnover Rate');
                }
            });

            function createBarPlot(data, xAxisLabel, yAxisLabel, title) {
                const x = data.map(item => item[xAxisLabel]);
                const y = data.map(item => item[yAxisLabel]);

                const trace = {
                    x: x,
                    y: y,
                    type: 'bar'
                };

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: yAxisLabel}
                };

                Plotly.newPlot(plotContainer, [trace], layout);
            }

            function createPieChart(data, labelsKey, valuesKey, title) {
                const labels = data.map(item => item[labelsKey]);
                const values = data.map(item => item[valuesKey]);

                const trace = {
                    labels: labels,
                    values: values,
                    type: 'pie'
                };

                const layout = {
                    title: title,
                    height: 400,
                    width: 500
                };

                Plotly.newPlot(plotContainer, [trace], layout);
            }

            function createScatterPlot(data, xAxisLabel, yAxisLabels, title) {
                const traces = yAxisLabels.map(label => {
                    return {
                        x: data.map(item => item[xAxisLabel]),
                        y: data.map(item => item[label]),
                        mode: 'markers',
                        name: label
                    };
                });

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: 'Value'},
                    showlegend: true
                };

                Plotly.newPlot(plotContainer, traces, layout);
            }

            function createStackedBarChart(data, xAxisLabel, stackLabel, yAxisLabel, title) {
                const uniqueXValues = [...new Set(data.map(item => item[xAxisLabel]))];
                const uniqueStackValues = [...new Set(data.map(item => item[stackLabel]))];

                const traces = uniqueStackValues.map(stackValue => {
                    const filteredData = data.filter(item => item[stackLabel] === stackValue);
                    return {
                        x: filteredData.map(item => item[xAxisLabel]),
                        y: filteredData.map(item => item[yAxisLabel]),
                        name: stackValue,
                        type: 'bar'
                    };
                });

                const layout = {
                    barmode: 'stack',
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: yAxisLabel}
                };

                Plotly.newPlot(plotContainer, traces, layout);
            }

            function createStoreCategoryFilters(data) {
                const uniqueStoreIDs = [...new Set(data.map(item => item['storeID']))];
                const uniqueCategories = [...new Set(data.map(item => item['Category']))];

                const storeDropdown = document.createElement('select');
                storeDropdown.id = 'store-filter';
                storeDropdown.className = 'filter';
                storeDropdown.innerHTML = '<option value="">All Stores</option>' + uniqueStoreIDs.map(id => `<option value="${id}">${id}</option>`).join('');

                const categoryDropdown = document.createElement('select');
                categoryDropdown.id = 'category-filter';
                categoryDropdown.className = 'filter';
                categoryDropdown.innerHTML = '<option value="">All Categories</option>' + uniqueCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

                filterContainer.appendChild(storeDropdown);
                filterContainer.appendChild(categoryDropdown);

                storeDropdown.addEventListener('change', applyFilters);
                categoryDropdown.addEventListener('change', applyFilters);
            }

            async function applyFilters() {
                const storeID = document.getElementById('store-filter').value;
                const category = document.getElementById('category-filter').value;

                const response = await fetch('/api/filter_store_performance_by_category', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({store_id: storeID, category: category})
                });

                const filteredData = await response.json();
                createStackedBarChart(filteredData, 'storeID', 'Category', 'total_quantity_sold', 'Store Performance by Category');
            }

            function createBubbleChart(data, xAxisLabel, yAxisLabel, textLabel1, textLabel2, title) {
                const trace = {
                    x: data.map(item => item[xAxisLabel]),
                    y: data.map(item => item[yAxisLabel]),
                    mode: 'markers',
                    marker: {
                        size: data.map(item => Math.sqrt(item[yAxisLabel]) * 5),
                        color: data.map(item => item[xAxisLabel])
                    },
                    text: data.map(item => `${item[textLabel1]}, ${item[textLabel2]}`)
                };

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: yAxisLabel},
                    showlegend: false
                };

                Plotly.newPlot(plotContainer, [trace], layout);
            }

            function createGroupedBarChart(data, xAxisLabel, yAxisLabels, title) {
                const traces = yAxisLabels.map(label => {
                    return {
                        x: data.map(item => item[xAxisLabel]),
                        y: data.map(item => item[label]),
                        name: label,
                        type: 'bar'
                    };
                });

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: 'Value'},
                    barmode: 'group',
                    showlegend: true
                };

                Plotly.newPlot(plotContainer, traces, layout);
            }

            // Trigger the change event to load the default chart on page load
            apiDropdown.dispatchEvent(new Event('change'));
        });
    </script>
</head>
<body>
<div class="container">
    <h1>Sales Dashboard</h1>
    <div id="filter-container"></div>
    <select id="api-dropdown">
        <option value="sales_by_day_of_week">Sales by Day of Week</option>
        <option value="product_size_sales">Product Size Sales</option>
        <option value="distance_analysis">Distance Analysis</option>
        <option value="store_performance_by_category">Store Performance by Category</option>
        <option value="customer_segmentation">Customer Segmentation</option>
        <option value="store_performance_comparison">Store Performance Comparison</option>
        <option value="inventory_turnover_rate">Inventory Turnover Rate</option>
        <option value="trend_analysis">Trend Analysis</option>
    </select>
    <div class="spinner"><div></div><div></div><div></div></div>
    <div id="plot-container"></div>
</div>
</body>
</html>
