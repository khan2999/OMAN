<!DOCTYPE html>
<html>
<head>
    <title>Sales Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            width: 80%;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            color: #333;
        }

        #view-charts-button {
            padding: 10px 20px;
            background-color: #007bff; /* Bootstrap blue */
            color: white;
            border: none;
            cursor: pointer;
        }

        #plot-container {
            display: none; /* Hide by default */
            width: 100%;
            height: 500px;
        }

        #api-dropdown {
            margin-bottom: 20px;
            padding: 8px;
            border: 1px solid #ccc;
        }

        #plot-container {
            width: 100%;
            height: 500px;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const apiDropdown = document.getElementById("api-dropdown");
            const plotContainer = document.getElementById("plot-container");
            const filterContainer = document.getElementById("filter-container");
            let viewChartsButton = document.getElementById("view-charts-button"); // Initial reference
            let currentApi = null;
            apiDropdown.addEventListener("change", async () => {
                const selectedApi = apiDropdown.value;
                currentApi = selectedApi;

                Plotly.purge(plotContainer);
                filterContainer.innerHTML = '';

                const response = await fetch(`/api/${selectedApi}`);
                const data = await response.json();

                if (selectedApi === 'sales_by_day_of_week') {
                    createBarPlot(data, 'Day of Week', 'Total Sales', 'Sales by Day of Week');
                } else if (selectedApi === 'product_size_sales') {
                    createPieChart(data, 'Size', 'total_quantity_sold', 'Product Size Sales');
                } else if (selectedApi === 'distance_analysis') {
                    createScatterPlot(data, 'distance_bin', ['aov_mean', 'order_frequency_mean', 'total_sales_mean'], 'Distance Analysis');
                } else if (selectedApi === 'store_performance_by_category') {
                    createStackedBarChart(data, 'storeID', 'Category', 'total_quantity_sold', 'Store Performance by Category');
                    createStoreCategoryFilters(data);
                } else if (selectedApi === 'average_order_value_over_time') {
                    createLineChart(data, 'month', 'average_order_value', 'Average Order Value Over Time');
                } else if (selectedApi === 'store_performance_comparison') {
                    createGroupedBarChart(data, 'storeID', ['total_sales', 'num_orders', 'average_order_size'], 'Store Performance Comparison');
                } else if (selectedApi === 'customer_segmentation') {
                    createBubbleChart(data, 'total_spend', 'num_orders', 'city', 'state', 'Customer Segmentation');
                } else if (selectedApi === 'inventory_turnover_rate') {
                    createBarPlot(data, 'SKU', 'turnover_rate', 'Inventory Turnover Rate');
                } else if (selectedApi === 'trend_analysis') {
                    createTrendAnalysisPlot(data, 'Sales Trend Analysis');
                }
            });

            function createBarPlot(data, xAxisLabel, yAxisLabel, title) {
                const x = data.map(item => item[xAxisLabel]);
                const y = data.map(item => item[yAxisLabel]);

                const trace = {
                    x: x,
                    y: y,
                    type: 'bar'
                };

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: yAxisLabel}
                };

                Plotly.newPlot(plotContainer, [trace], layout);
            }

            function createLineChart(data, xAxisLabel, yAxisLabel, title) {
                const x = data.map(item => item[xAxisLabel]);
                const y = data.map(item => item[yAxisLabel]);

                const trace = {
                    x: x,
                    y: y,
                    type: 'scatter',
                    mode: 'lines+markers'
                };

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: yAxisLabel}
                };

                Plotly.newPlot(plotContainer, [trace], layout);
            }

            function createPieChart(data, labelsKey, valuesKey, title) {
                const labels = data.map(item => item[labelsKey]);
                const values = data.map(item => item[valuesKey]);

                const trace = {
                    labels: labels,
                    values: values,
                    type: 'pie'
                };

                const layout = {
                    title: title,
                    height: 400,
                    width: 500
                };

                Plotly.newPlot(plotContainer, [trace], layout);
            }

            function createScatterPlot(data, xAxisLabel, yAxisLabels, title) {
                const traces = yAxisLabels.map(label => {
                    return {
                        x: data.map(item => item[xAxisLabel]),
                        y: data.map(item => item[label + '_mean']),
                        error_y: {
                            type: 'data',
                            array: data.map(item => item[label + '_std']),
                            visible: true
                        },
                        name: label,
                        mode: 'markers'
                    };
                });

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: 'Mean Value'},
                    showlegend: true
                };

                Plotly.newPlot(plotContainer, traces, layout);
            }

            function createStackedBarChart(data, xAxisLabel, stackLabel, yAxisLabel, title) {
                const uniqueXValues = [...new Set(data.map(item => item[xAxisLabel]))];
                const uniqueStackValues = [...new Set(data.map(item => item[stackLabel]))];

                const traces = uniqueStackValues.map(stackValue => {
                    const filteredData = data.filter(item => item[stackLabel] === stackValue);
                    return {
                        x: filteredData.map(item => item[xAxisLabel]),
                        y: filteredData.map(item => item[yAxisLabel]),
                        name: stackValue,
                        type: 'bar'
                    };
                });

                const layout = {
                    barmode: 'stack',
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: yAxisLabel}
                };

                Plotly.newPlot(plotContainer, traces, layout);
            }

            function createStoreCategoryFilters(data) {
                const uniqueStoreIDs = [...new Set(data.map(item => item['storeID']))];
                const uniqueCategories = [...new Set(data.map(item => item['Category']))];

                const storeDropdown = document.createElement('select');
                storeDropdown.id = 'store-filter';
                storeDropdown.innerHTML = '<option value="">All Stores</option>' + uniqueStoreIDs.map(id => `<option value="${id}">${id}</option>`).join('');

                const categoryDropdown = document.createElement('select');
                categoryDropdown.id = 'category-filter';
                categoryDropdown.innerHTML = '<option value="">All Categories</option>' + uniqueCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

                filterContainer.appendChild(storeDropdown);
                filterContainer.appendChild(categoryDropdown);

                storeDropdown.addEventListener('change', applyFilters);
                categoryDropdown.addEventListener('change', applyFilters);
            }

            async function applyFilters() {
                const storeID = document.getElementById('store-filter').value;
                const category = document.getElementById('category-filter').value;

                const queryParams = new URLSearchParams({
                    store_id: storeID,
                    category: category
                });

                const response = await fetch(`/api/${currentApi}?${queryParams.toString()}`);
                const filteredData = await response.json();

                Plotly.react(plotContainer, filteredData.data, filteredData.layout);
            }

            function createGroupedBarChart(data, xAxisLabel, yAxisLabels, title) {
                const traces = yAxisLabels.map(label => {
                    return {
                        x: data.map(item => item[xAxisLabel]),
                        y: data.map(item => item[label]),
                        name: label,
                        type: 'bar'
                    };
                });

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: 'Value'},
                    barmode: 'group',
                    showlegend: true
                };

                Plotly.newPlot(plotContainer, traces, layout);
            }

            function createBubbleChart(data, xAxisLabel, yAxisLabel, textLabel1, textLabel2, title) {
                const trace = {
                    x: data.map(item => item[xAxisLabel]),
                    y: data.map(item => item[yAxisLabel]),
                    mode: 'markers',
                    marker: {
                        size: data.map(item => Math.sqrt(item[xAxisLabel]) * 5),
                        color: data.map(item => item[textLabel2])
                    },
                    text: data.map(item => `${item[textLabel1]}, ${item[textLabel2]}`)
                };

                const layout = {
                    title: title,
                    xaxis: {title: xAxisLabel},
                    yaxis: {title: yAxisLabel},
                    showlegend: false
                };

                Plotly.newPlot(plotContainer, [trace], layout);
            }

            function createTrendAnalysisPlot(data, title) {
                const x = data.map(item => item['month']);
                const y = data.map(item => item['total_sales']);

                const trace = {
                    x: x,
                    y: y,
                    type: 'scatter',
                    mode: 'lines+markers'
                };

                const layout = {
                    title: title,
                    xaxis: {title: 'Month'},
                    yaxis: {title: 'Total Sales'}
                };

                Plotly.newPlot(plotContainer, [trace], layout);
            }
            function attachButtonListener() { // Function to attach listener
                viewChartsButton.addEventListener("click", () => {
                    plotContainer.style.display = 'block';
                    viewChartsButton.style.display = 'none';
                    apiDropdown.dispatchEvent(new Event('change'));
                });
            }

            attachButtonListener();


            viewChartsButton.addEventListener("click", () => { // Event listener here
                plotContainer.style.display = 'block';
                viewChartsButton.style.display = 'none';
                apiDropdown.dispatchEvent(new Event('change')); // Trigger chart creation
                 attachButtonListener();
            });
        });
    </script>

</head>
<body>
<div class="container">
    <h1>More chart to Analyse</h1>
    <div id="filter-container"></div>
    <select id="api-dropdown">
        <option value="sales_by_day_of_week">Sales by Day of Week</option>
        <option value="product_size_sales">Product Size Sales</option>
        <option value="distance_analysis">Distance Analysis</option>
        <option value="store_performance_by_category">Store Performance by Category</option>
        <option value="average_order_value_over_time">Average Order Value Over Time</option>
        <option value="store_performance_comparison">Store Performance Comparison</option>
        <option value="customer_segmentation">Customer Segmentation</option>
        <option value="inventory_turnover_rate">Inventory Turnover Rate</option>
        <option value="trend_analysis">Trend Analysis</option>
    </select>
    <button id="view-charts-button">View Charts</button>
    <div id="plot-container"></div>
</div>
</div>
</body>
</html>

